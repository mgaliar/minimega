apiVersion: phenix.sandia.gov/v1
kind: Image
metadata:
  name: elasticsearch 
spec:
  compress: false
  deb_append: ' --components=main,restricted,universe,multiverse'
  format: qcow2
  mirror: http://us.archive.ubuntu.com/ubuntu/
  overlays: null
  packages:
  - initramfs-tools
  - net-tools
  - isc-dhcp-client
  - openssh-server
  - init
  - iputils-ping
  - vim
  - less
  - netbase
  - curl
  - ifupdown
  - dbus
  - linux-image-generic
  - linux-headers-generic
  - xserver-xorg-video-qxl
  - xserver-xorg-video-vesa
  - xubuntu-desktop
  - firefox
  - tcpdump
  ramdisk: false
  release: focal
  script_order:
  - POSTBUILD_APT_CLEANUP
  - POSTBUILD_NO_ROOT_PASSWD
  - POSTBUILD_PHENIX_HOSTNAME
  - /phenix/vmdb/scripts/elasticsearch.sh
  scripts:
    /phenix/vmdb/scripts/elasticsearch.sh: |
      curl -k -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-oss-7.9.3-amd64.deb
      curl -k -L -O https://artifacts.elastic.co/downloads/kibana/kibana-oss-7.9.3-amd64.deb
      apt install ./elasticsearch-oss-7.9.3-amd64.deb
      apt install ./kibana-oss-7.9.3-amd64.deb
      rm ./elasticsearch-oss-7.9.3-amd64.deb
      rm ./kibana-oss-7.9.3-amd64.deb
      ln -s /lib/systemd/system/elasticsearch.yml /etc/systemd/system/multi-user.target.wants/elasticsearch.yml
      ln -s /etc/systemd/system/kibana.yml /etc/systemd/system/multi-user.target.wants/kibana.yml
      cat > /root/.profile <<EOF
      # ~/.profile: executed by Bourne-compatible login shells.
      if [ "$BASH" ]; then
        if [ -f ~/.bashrc ]; then
          . ~/.bashrc
        fi
      fi
      tty -s && mesg n || true
      EOF
      cat > /etc/lightdm/lightdm.conf <<EOF
      [Seat:*]
      autologin-guest=false
      autologin-user=root
      autologin-user-timeout=0
      EOF
      mkdir -p /root/.config/autostart
      cat > /root/.config/autostart/Kibana.desktop <<EOF
      [Desktop Entry]
      Encoding=UTF-8
      Version=1.0
      Type=Application
      Name=Kibana
      Comment=Kibana Browser
      # HACK: The "Path" option isn't honored on autostart
      # (see https://gitlab.xfce.org/xfce/xfce4-session/-/issues/9).
      Exec=firefox http://localhost:5601
      OnlyShowIn=XFCE;
      StartupNotify=false
      Terminal=false
      Hidden=false
      EOF
    POSTBUILD_APT_CLEANUP: |
      apt clean || apt-get clean || echo "unable to clean apt cache"
    POSTBUILD_NO_ROOT_PASSWD: |
      sed -i 's/nullok_secure/nullok/' /etc/pam.d/common-auth
      sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
      sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords yes/' /etc/ssh/sshd_config
      sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
      sed -i 's/PermitEmptyPasswords no/PermitEmptyPasswords yes/' /etc/ssh/sshd_config
      passwd -d root
    POSTBUILD_PHENIX_HOSTNAME: |
      echo "phenix" > /etc/hostname
      sed -i 's/127.0.1.1 .*/127.0.1.1 phenix/' /etc/hosts
      cat > /etc/motd <<EOF

      ██████╗ ██╗  ██╗███████╗███╗  ██╗██╗██╗  ██╗
      ██╔══██╗██║  ██║██╔════╝████╗ ██║██║╚██╗██╔╝
      ██████╔╝███████║█████╗  ██╔██╗██║██║ ╚███╔╝
      ██╔═══╝ ██╔══██║██╔══╝  ██║╚████║██║ ██╔██╗
      ██║     ██║  ██║███████╗██║ ╚███║██║██╔╝╚██╗
      ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚══╝╚═╝╚═╝  ╚═╝

      EOF
      echo "\nBuilt with phenix image on $(date)\n\n" >> /etc/motd
  size: 10G
  variant: minbase